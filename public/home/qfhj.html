<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="./vant.index.css">
    <link rel="stylesheet" href="./common.css">
    <style>
        [v-cloak] {
            display: none;
        }

        #app {
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .logo {
            width: 200px;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <img class="logo" src="./wxpay.png" alt="">
        <p class="scan-tip">订单号：<span>{{orderNo}}</span></p>
        <van-loading size="200px" color="#4fc08d" v-show="isLoading"></van-loading>
        <div v-show='showcode && !isLoading' id="qrcode"></div>
        <div v-show='!showcode' classs="temp-qrcode"></div>
        <div class="remainseconds scan-tip">
            <span>[支付有效时间]</span>
            <span class="red" v-html="stateHtml"></span>
        </div>
        <p class="red scan-tip">请务必填写准确金额，否则无法到账!!！</p>
        <p class="red scan-tip">请务必填写准确金额，否则无法到账!!！</p>
        <p class="red scan-tip">请务必填写准确金额，否则无法到账!!！</p>
        <div class="layout-row">
            <div class="layout-row">
                <h3>￥</h3>
                <h3 class="bold" id="remark">{{ orderData.payMoney }} </h3>
            </div>
            <button style="background:#28a538;padding: .25rem .25rem;margin-left:10px;" class="copy-link" data-clipboard-target="#remark"> 复制金额</button>
        </div>
        <h3 class="red">具体支付方式如下</h3>
        <p class="">1.请截图保存该页面</p>
        <p class="">2.打开微信扫一扫</p>
        <p class="">3.选择相册保存的二维码进行识别支付</p>
    </div>
</body>
<script src="./polyfill.min.js"></script>
<script src="./vue.min.js"></script>
<script src="./axios.min.js"></script>
<script src="./vant.js"></script>
<script src="./dayjs.min.js"></script>
<script src="./clipboard.min.js"></script>
<script src="./utils.js"></script>
<script type='text/javascript' src='./qrcode.min.js' charset='utf-8'></script>
<script type='text/javascript' src='./payWay.js' charset='utf-8'></script>
<script>
    const orderState = () => {
        return new Promise((resolve, reject) => {
            axios({
                method: "POST",
                url: frontUrl + '/backend/order/findOrderNum',
                data: {
                    orderNum: getUserParam("orderNo"),
                },
            }).then(res => {
                resolve(res)
            }).catch(err => {
                reject(err)
            })
        })
    }
    Vue.use(vant.Button);
    Vue.use(vant.Loading);
    let payVM = new Vue({
        el: '#app',
        data() {
            return {
              isLoading: true,
                showYD: false,
                orderNo: this.getUserParam('orderNo'),
                orderData: {
                },
                showcode: true,
                stateHtml: '0分 0秒',
                first: true,
                siv: null,
                dSiv: null,
                overlay: true,
                time: 0,
                showTip: false,
            }
        },
        computed: {

        },
        created() {

        },
        mounted() {
            let _self = this;
            this.$nextTick(() => {
                const clipboard = new ClipboardJS(".copy-link");
                clipboard.on("success", function (e) {
                    vant.Dialog.alert({
                        message: '金额已复制, 请直接到付款页面粘贴付款即可'
                    })
                    e.clearSelection();
                });
                clipboard.on("error", function (e) {
                    vant.Dialog.alert({
                        message: '复制失败，请手动复制'
                    })
                });
            })
            this.orderState()
            // this.siv = setInterval(() => {
            //     this.orderState()
            // }, 3000);
        },
        methods: {
            getUserParam(key) {
                return getUserParam(key)
            },
            orderState() {

                orderState().then(res => {
                    if (res.data.code == 200) {
                        if (res.data.data) {
                            let data = res.data.data;
                            if (this.first) {
                                this.orderData = data
                                this.countDown()
                                this.first = false;
                                this.showcode = true;
                                const { qrUrl } = JSON.parse(data.payContent)
                                setTimeout(() => {
                                    new QRCode(document.getElementById("qrcode"), {
                                        text: qrUrl,
                                        width: 200,
                                        height: 200,
                                        colorDark: "#000000",
                                        colorLight: "#ffffff",
                                    });
                                    this.isLoading = false
                                }, 1000)
                            }
                        } else {
                            this.isLoading = false
                            this.showcode = false
                            if (res.data.message === "订单支付成功") {
                                vant.Dialog.alert({
                                    message: '订单支付成功'
                                })
                                clearInterval(this.siv)
                                clearInterval(this.dSiv)
                                this.orderData.state = '支付成功'
                                this.stateHtml = '支付成功！'
                            } else {
                                throw (res.data.message)
                            }
                        }
                    } else {
                        this.showcode = false
                        this.isLoading = false
                        throw (res.data.message)
                    }
                }).catch(err => {
                  this.isLoading = false
                    clearInterval(this.siv)
                    clearInterval(this.dSiv)
                    vant.Dialog.alert({
                        message: err
                    })
                }).finally(_ => {

                    this.overlay = false;
                })
            },
            countDown() {
                let endTime = dayjs(this.orderData.createTime)
                endTime = endTime.add(this.orderData.orderTimeOut || 5, 'm');
                this.dSiv = setInterval(() => {
                    this.diffTime = dayjs(endTime).diff(dayjs(), 'second');
                    //分钟
                    let minutes = Math.floor(this.diffTime / 60);
                    let seconds = this.diffTime % 60;
                    this.stateHtml = `${minutes}分 ${seconds}秒`
                    if (this.diffTime <= 0) {
                        clearInterval(this.dSiv)
                        this.showcode = false;
                        vant.Dialog.alert({
                            message: '订单超时，请勿支付！'
                        })
                    }
                }, 1000);
            },
        },
    })
</script>

</html>
